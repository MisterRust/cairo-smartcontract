%lang starknet

from starkware.cairo.common.cairo_builtins import HashBuiltin
from starkware.cairo.common.bool import TRUE, FALSE
from starkware.starknet.common.syscalls import get_caller_address, get_block_timestamp
from starkware.cairo.common.math import assert_le

from contracts.convoys.library import assert_can_spend_convoy, has_convoy
from contracts.map.world import Plot, Structure, world, world_update
from contracts.colonies import find_redirected_colony
from contracts.map.biomes import assert_jungle_or_forest, assert_not_ocean
from contracts.convoys.conveyables.fungibles import Fungibles
from contracts.convoys.conveyables.fungibles.wood import Wood, wood_balances

@storage_var
func exploitation_start(x : felt, y : felt) -> (timestamp : felt):
end

func _build_lumber_camp{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}(
    convoy_id : felt, x : felt, y : felt
) -> ():
    # Build a lumber camp at the given location.
    #
    # Parameters:
    #   convoy_id: The id of the convoy.
    #   x: The x coordinate of the lumber camp.
    #   y: The y coordinate of the lumber camp.
    alloc_locals
    let (test) = has_convoy(convoy_id, x, y)
    assert test = TRUE

    let (existing_plot : Plot) = world.read(x, y)
    if existing_plot.structure != Structure.NONE and
        existing_plot.structure != Structure.SETTLER_CAMP:
        assert 1 = 0
    end

    let (colony) = find_redirected_colony(existing_plot.owner)
    let (caller) = get_caller_address()
    assert colony.owner = caller
    assert_can_spend_convoy(convoy_id, caller)

    # todo: remove 10 woods
    let (wood_amount) = Fungibles.amount(wood_balances.addr, convoy_id)
    assert_le(10, wood_amount)
    Fungibles.set(wood_balances.addr, convoy_id, wood_amount - 10)

    let (timestamp) = get_block_timestamp()
    assert_jungle_or_forest(x, y)

    # 300sec = 5min
    exploitation_start.write(x, y, timestamp + 300)
    world.write(x, y, Plot(colony.owner, Structure.LUMBER_CAMP, timestamp + 300))
    return ()
end

func _build_town{syscall_ptr : felt*, pedersen_ptr : HashBuiltin*, range_check_ptr}(
    convoy_id : felt, x : felt, y : felt
) -> ():
    # Build a town at the given location.
    #
    # Parameters:
    #   convoy_id: The id of the convoy.
    #   x: The x coordinate of the town.
    #   y: The y coordinate of the town.
    alloc_locals
    let (test) = has_convoy(convoy_id, x, y)
    assert test = TRUE

    let (existing_plot : Plot) = world.read(x, y)
    if existing_plot.structure != Structure.NONE and
        existing_plot.structure != Structure.SETTLER_CAMP:
        assert 1 = 0
    end

    let (colony) = find_redirected_colony(existing_plot.owner)
    let (caller) = get_caller_address()
    assert colony.owner = caller
    assert_can_spend_convoy(convoy_id, caller)

    # todo: remove 50 woods
    let (wood_amount) = Fungibles.amount(wood_balances.addr, convoy_id)
    assert_le(50, wood_amount)
    Fungibles.set(wood_balances.addr, convoy_id, wood_amount - 50)

    let (timestamp) = get_block_timestamp()
    assert_not_ocean(x, y)

    # 600sec = 10min
    world.write(x, y, Plot(colony.owner, Structure.TOWN, timestamp + 600))
    return ()
end
